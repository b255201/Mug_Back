@using Mug.Dao;
@model Blogger
@{
    ViewBag.Title = "修改-關於頁";
}

<h1 style="color:red">修改-關於頁</h1>
<br />
<br />
<form id="frmSub" class="form-horizontal" enctype="multipart/form-data">
    <div class="form-group">
        <label for="file" class="col-sm-2 control-label">圖片</label>
        <div class="col-sm-3">
            @Html.EditorFor(c => c.Image, new { htmlAttributes = new { type = "file", name = "Image", @class = "form-control", onchange = "onfileChange();" } })
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">預覽</label>
        <div class="col-sm-3">
            <a id="PreImgName">@ViewBag.Image</a>
            <img id="preimg" class="img-thumbnail thumb imgthumb" src="@Url.Action("GetImageFile","Home",new { fileName= Model.Image })" />
        </div>
    </div>
    <div class="form-group">
        <label for="file" class="col-sm-2 control-label">是否啟用</label>
        <div class="col-sm-3">
            @if (ViewBag.Enable == "True")
            {
                <input type="checkbox" id="Enable" name="Enable" checked />
            }
            else
            {
                <input type="checkbox" id="Enable" name="Enable" />
            }
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-2"></div>
        <div class="col-sm-3">
            <button type="button" class="btn btn-primary" onclick="onSave();">儲存</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="javascript:location.href='/About/Index'">回查詢頁</button>
        </div>
    </div>
    @Html.HiddenFor(c => c.Blog_id);
    <input hidden type="text" id="OrgImgName" name="OrgImgName" value="@ViewBag.Image">
</form>
<!--文章內容-->


@{
    foreach (var i in ViewBag.Article)
    {

        <hr />

        if (i.Id == 1)
        {
            <h1>編輯 - 英文  </h1>
        }
        else if (i.Id == 2)
        {
            <h1>編輯 - 中文  </h1>
        }
        else if (i.Id == 3)
        {
            <h1>編輯 - 日文  </h1>
        }

        <br /><br />

        <form id="frmSub" class="form-horizontal" enctype="multipart/form-data">
            <div class="form-group">
                <label for="Title@(i.Id)" class="col-sm-2 control-label">標題</label>
                <div class="col-sm-10">
                    <input type="text" class="theinput form-control" id="Title_@(i.Id)" value="@(i.Title)" name="Title" />
                </div>
            </div>
            @*<div class="form-group">
                    <label for="SubTitle" class="col-sm-2 control-label">子標題</label>
                    <div class="col-sm-10">
                        <input type="text" class="theinput form-control" id="SubTitle@(i.Id)" value="@(i.Sub_Title)" name="SubTitle" />
                    </div>
                </div>*@
            <div class="form-group">
                <label for="Contents" class="col-sm-2 control-label">內文</label>
                <div class="col-sm-10">
                    <textarea class="theinput form-control" id="Contents_@(i.Id)" name="Contents">@(i.Contents)</textarea>
                </div>
            </div>

            <div class="form-group">
                <div class="col-sm-2"></div>
                <div class="col-sm-3">
                    <button type="button" id="AtricleBtn" class="btn btn-primary" onclick="onSaveLang(@(i.Article_ID),@(i.Id));">儲存</button>
                </div>
            </div>
        </form>
    }
}


@section Scripts
{
    <script src="@Url.Content("~/Scripts/ckeditor/ckeditor.js")" type="text/javascript"></script>
    <script>
    $(function () {

          var model =@Html.Raw(Json.Encode(ViewBag.Lang_Id));
        for (var i = 0; i < model.length; i++) {
            var key = "Contents_" + model[i].Id;
            {
                 CKEDITOR.replace( key, {  skin: 'kama', width: '800px',} );
            }

        }

        });
        function onfileChange() {
            var filename = $('#Image').val();
            filename = filename.substring(filename.lastIndexOf('\\') + 1);
            var input = document.getElementById("Image");
            var fReader = new FileReader();
            fReader.readAsDataURL(input.files[0]);
            fReader.onloadend = function (event) {
                var img = document.getElementById("preimg");
                img.src = event.target.result;
                $("#PreImgName").text(filename);
            }
        }


     function onSave() {
            if ($("#PreImgName").text() == "") {
            alert("請上傳圖片");
            return false;
            }
            var fileData = new FormData();
            var file = $("#Image");//.get(0);
            var isEmpty = true;
            for (var i = 0; i < file.length; i++) {
                if (file[i].files.length > 0) {
                    fileData.append(file[i].files[0].name, file[i].files[0]);
                    isEmpty = false;
                }
            }
         fileData.append("Enable", $("#Enable").prop("checked"));
         fileData.append("Blog_id", $("#Blog_id").val());
           lockScreen();
           $.ajax({
            url: '@Url.Action("Edit")',
            type: "POST",
            contentType: false,  // Not to set any content header
            processData: false,  // Not to process data
            data: fileData,
            success: function (data)
            {
                unlockScreen();
                var message = data.Message;
                if (data.Status == "0") {
                    alert('' + data.Message);
                }
                else if (data.Status == "1") {

                    alert('' + data.Message);
                }
            },
            error: function (err) {
                unlockScreen();
                alert(err.status);
            }
        });
    }



     function onSaveLang(ArticleID,lang)
     {

        var CkeditorText=   CKEDITOR.instances["Contents_"+lang].getData();
        var Title = $("#Title_"+lang).val();
        if (Title.trim() == "") {
        alert("請輸入標題");
        return false;
        }
        var fileData = new FormData();
        fileData.append("Title", Title);
        fileData.append("Contents", CkeditorText);
        fileData.append("Article_ID", ArticleID);
         lockScreen();
           $.ajax({
            url: '@Url.Action("EditCkeditor","ArticlePartial")',
            type: "POST",
            contentType: false,  // Not to set any content header
            processData: false,
            data: fileData,
            success: function (data)
            {
                unlockScreen();
                var message = data.Message;
                if (data.Status == "0") {
                    alert('' + data.Message);
                }
                else if (data.Status == "1") {
                    alert('' + data.Message);
                }
            },
            error: function (err) {
                unlockScreen();
                alert(err.status);
            }
        });
    }
    </script>
}
